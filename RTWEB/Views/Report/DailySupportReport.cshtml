@using RTWEB.ViewModel;
@model List<CustomerSolvedIssueVM>
@{
    ViewData["Title"] = "Daily Support";
}
<style>
    .print-hide {
        display: none !important;
    }

    /* Table column widths */
    .custom-table th, .custom-table td {
        border: 1px solid #000 !important;
    }

        .custom-table th:nth-child(1),
        .custom-table td:nth-child(1) {
            width: 3% !important;
            text-align: center;
        }

        .custom-table th:nth-child(2),
        .custom-table td:nth-child(2) {
            width: 5% !important;
            text-align: center;
        }

        .custom-table th:nth-child(3),
        .custom-table td:nth-child(3) {
            width: 6% !important;
            text-align: center;
        }

        .custom-table th:nth-child(4),
        .custom-table td:nth-child(4) {
            width: 15% !important;
           
        }

        .custom-table th:nth-child(5),
        .custom-table td:nth-child(5) {
            width: 55% !important;
            word-wrap: break-word;
        }

    @@media print {
        body * {
            visibility: hidden !important;
        }

        .domain-dropdown,
        .domain-dropdown + .select2-container {
            display: none !important;
        }

        .page-container, .page-container * {
            visibility: visible !important;
        }

        button, .btn, a.btn {
            display: none !important;
        }

        .hidePrint {
            display: none !important;
        }

        table, th, td {
            border: 1px solid #000 !important;
            border-collapse: collapse !important;
        }

            table th, table td {
                background: none !important;
                color: #000 !important;
                font-size: 15pt !important;
                padding: 4pt !important;
            }

        body {
            background: white !important;
            font-size: 17pt !important;
            line-height: 1.2 !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .print-hide {
            display: block !important;
        }
    }
</style>

<div class="container mt-4 page-container">
    <div class="card custom-card print-hide p-3 text-center">
        <h1>Daily Support</h1>
        <p>Date: @DateTime.Now.ToString("dd-MM-yyyy : hh:mm tt")</p>
    </div>

    <!-- Filter Form -->
    <form asp-action="DailySupportReport" method="post" class="mb-3">
        <!-- First Row -->
        <div class="row g-3 mb-2 hidePrint">
            <div class="col-md-3">
                <label class="form-label">From</label>
                <div class="input-group">
                    <input type="text" id="fromDate" name="fromDate" class="form-control" />
                    <span class="input-group-text"><i class="fa fa-calendar"></i></span>
                </div>
            </div>

            <div class="col-md-3">
                <label class="form-label">To</label>
                <div class="input-group">
                    <input type="text" id="toDate" name="toDate" class="form-control" />
                    <span class="input-group-text"><i class="fa fa-calendar"></i></span>
                </div>
            </div>

            <div class="col-md-3">
                <label class="form-label">Domain</label>
                <select id="domainId" name="domainId" class="form-control domain-dropdown">
                    <option value="">-- Select Domain --</option>
                    @foreach (var p in ViewBag.Domain as List<SelectListItem>)
                    {
                        <option value="@p.Value">@p.Text</option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Solved By</label>
                <select id="" name="solvedBy" class="form-control team-dropdown">
                    <option value="">-- Select Solved By --</option>
                    @foreach (var p in ViewBag.Team as List<SelectListItem>)
                    {
                        <option value="@p.Value">@p.Text</option>
                    }
                </select>
            </div>
        </div>

        <!-- Second Row -->
        <div class="row g-3 align-items-end hidePrint">
            <div class="col-md-4">
                <label class="form-label">Customer</label>
                <select id="customerId" name="customerId" class="form-control developer-dropdown" disabled>
                    <option value="">-- Select Customer --</option>
                </select>
            </div>

            <div class="col-md-8 d-flex flex-wrap align-items-end">
                <button type="submit" class="btn btn-primary me-2 mb-2">View</button>
                <a class="btn btn-danger me-2 mb-2" asp-action="DailySupportReport">Reset</a>
                <button type="button" class="btn btn-info me-2 mb-2" onclick="window.print()">
                    <i class="fa fa-print"></i>
                </button>
                <a class="btn btn-primary mb-2" asp-controller="SolvedIssue" asp-action="Index">Solved List</a>
            </div>
        </div>
    </form>

    @if (Model != null && Model.Any())
    {
        // group by SolvedBy
        var grouped = Model.GroupBy(x => x.SolvedBy).OrderBy(g => g.Key);
        var sl = 1;

        <table class="table table-bordered custom-table">
            <thead>
                <tr>
                    <th>Sl</th>
                    <th>Date</th>
                    <th>Customer</th>
                    <th>Issues</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var group in grouped)
                {
                    <tr class="table">
                        <td colspan="5"><strong>Solved By: @group.Key</strong></td>
                    </tr>
                    @foreach (var item in group)
                    {
                        <tr>
                            <td>@sl</td>
                            <td>@item.SolvedDate?.ToString("dd-MM-yyyy")</td>
                            <td>@item.CustomerName <br /> ||<br />@item.DomainName</td>
                            <td>
                                @if (item.SolveDetails != null && item.SolveDetails.Any())
                                {
                                    <ol>
                                        @foreach (var d in item.SolveDetails)
                                        {
                                            <li>@d.IssueName</li>
                                        }
                                    </ol>
                                }
                            </td>
                        </tr>
                        sl++;
                    }
                }
            </tbody>
        </table>
    }
    else
    {
        <p>No data available for the selected criteria.</p>
    }
</div>

<script>
    $(function () {
        var today = new Date();
        var todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());

        $("#fromDate").datepicker({
            dateFormat: "dd-mm-yy",
            changeMonth: true,
            changeYear: true
        }).datepicker("setDate", todayDate);

        $("#toDate").datepicker({
            dateFormat: "dd-mm-yy",
            changeMonth: true,
            changeYear: true
        }).datepicker("setDate", todayDate);

        $(".input-group-text").click(function () {
            $(this).prev("input").focus();
        });
    });

    $(document).ready(function () {
        $(".domain-dropdown").select2({
            placeholder: "--Select Domain--",
            allowClear: true,
            width: '100%'
        });
        $(".team-dropdown").select2({
            placeholder: "--Select Solved By--",
            allowClear: true,
            width: '100%'
        });
        $(".developer-dropdown").select2({
            placeholder: "--Select Customer--",
            allowClear: true,
            width: '100%'
        });

        $(document).on('select2:open', () => {
            document.querySelector('.select2-search__field').focus();
        });

        // domain change -> load customers
        $('#domainId').on('change', function () {
            var domainId = $(this).val();
            var $customerDropdown = $('#customerId');

            $customerDropdown.empty()
                .append('<option value="">-- Select Customer --</option>')
                .prop('disabled', true);

            if (domainId) {
                $.ajax({
                    url: '/SolvedIssue/DomainWiseCustomer',
                    type: 'GET',
                    data: { domainId: domainId },
                    dataType: 'json',
                    success: function (data) {
                        $.each(data, function (i, customer) {
                            $customerDropdown.append($('<option>', {
                                value: customer.id,
                                text: customer.customerName
                            }));
                        });
                        $customerDropdown.prop('disabled', false);
                    }
                });
            }
        });
    });
</script>
